
<!DOCTYPE html>


<html lang="en" data-content_root="../../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Question Answering</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css?v=22107f9c" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/intro.css?v=adbe4504" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-GJG3T4ZRZH"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-GJG3T4ZRZH');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-GJG3T4ZRZH');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'content/genai/langchain/projects/2_Question_Answering';</script>
    <link rel="canonical" href="https://mlguide.in/content/genai/langchain/projects/2_Question_Answering.html" />
    <link rel="icon" href="../../../../_static/logo.png"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" /> 
<link
  rel="alternate"
  type="application/atom+xml"
  href="../../../resources/blogs/atom.xml"
  title="Blog"
/>
  
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../../_static/MLGuide_logo_nb.png" class="logo__image only-light" alt=" - Home"/>
    <img src="../../../../_static/MLGuide_logo_nb.png" class="logo__image only-dark pst-js-only" alt=" - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Guide</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../python/python_toc.html">Python</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../python/1_installation.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../python/2_syntax_and_symantics.html">Syntax &amp; Symantics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../python/3_functions_and_modules.html">Functions &amp; Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../python/4_Object_Oriented.html">Object Oriented Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../python/5_Exceptions_Handling.html">Exceptions Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../python/6_Handling_Files.html">Handling Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../python/7_Datetime_Operations.html">Datetime Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../python/8_advanced.html">Advanced Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../python/conceptual_topics.html">Interpreter vs Compiler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../python/exercises.html">Exercises</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../../statistics/statistics-101.html">Statistics</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../mathematics/mathematics_toc.html">Mathematics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../mathematics/linear-algebra_vectors.html">Vectors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../mathematics/linear-algebra_matrices.html">Matrices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../mathematics/dissimilarity_measures.html">Similarity measure</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../analytics/intro_analytics.html">Data analytics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../analytics/numpy/numpy_toc.html">Numpy</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../analytics/numpy/001_Python_NumPy.html">NumPy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analytics/numpy/Python_Numpy_Exercises_with_hints.html">Exercises</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../analytics/pandas/pandas_toc.html">Pandas</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../analytics/pandas/001_Python_Pandas_DataFrame.html">Pandas</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analytics/pandas/002_Pandas_HowTos.html">How To's</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analytics/pandas/003_Pandas_Exercises.html">Exercises</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../analytics/matplotlib/matplotlib_toc.html">Matplotlib</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../analytics/matplotlib/001_Python_Matplotlib.html">Matplotlib</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../analytics/matplotlib/003_Python_Matplotlib_Exercises.html">Exercises</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../ai/Introduction_to_ml.html">Machine Learning</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../ai/classicml/concepts/01_Introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ai/classicml/concepts/000_Data_Exploration.html">Exploratory Data Analysis</a></li>

<li class="toctree-l2"><a class="reference internal" href="../../../ai/classicml/concepts/001_Data_Preparation.html">Data Preparation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ai/classicml/concepts/002_Regression.html">Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ai/classicml/concepts/003_Classification.html">Classfication</a></li>

<li class="toctree-l2"><a class="reference internal" href="../../../ai/classicml/concepts/004_Clustering.html">Clustering</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ai/classicml/concepts/005_Evaluation.html">Evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ai/classicml/concepts/006_Advanced.html">K-Fold Cross Validation</a></li>


<li class="toctree-l2"><a class="reference internal" href="../../../ai/classicml/concepts/007_Dimensionality_Reduction.html">Dimensionality Reduction</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../ai/neural/neural_toc.html">Neural Networks</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../ai/neural/concepts/001_Introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ai/neural/concepts/002_Backpropogation.html">Backpropogation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ai/neural/concepts/003_Activations.html">Activations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ai/neural/concepts/004_Optimization.html">Optimizations</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../ai/neural/concepts/pytorch/pytorch_toc.html">Pytorch</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../ai/neural/concepts/pytorch/00_pytorch_fundamentals.html">Fundamentals</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../ai/neural/concepts/pytorch/01_pytorch_workflow.html">Workflow</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../ai/neural/concepts/pytorch/02_pytorch_classification.html">Classification</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../ai/neural/concepts/pytorch/03_pytorch_computer_vision.html">Computer Vision</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../ai/neural/concepts/pytorch/04_pytorch_custom_datasets.html">Custom Datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../ai/neural/concepts/pytorch/06_pytorch_transfer_learning.html">Transfer Learning</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../ai/nlp/nlp_intro.html">Natural Language Processing</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../ai/nlp/concepts/001_traditional_nlp.html">Word Vectors &amp; Dependency Parsing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ai/nlp/concepts/002_embeddings.html">Embeddings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ai/nlp/concepts/003_ngram_cnn.html">N Gram using CNN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ai/nlp/concepts/004_word2vec.html">Word2Vec</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ai/nlp/concepts/005_language_model_basic.html">Neural Language Model</a></li>

<li class="toctree-l2"><a class="reference internal" href="../../../ai/nlp/concepts/006_language_model_rnn.html">Recurrent Neural Network (RNN)</a></li>

<li class="toctree-l2"><a class="reference internal" href="../../../ai/nlp/concepts/007_encoder_decoder.html">Encoder Decoder</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ai/nlp/concepts/008_attention.html">Attention</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ai/nlp/concepts/009_transformer.html">Transformer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ai/nlp/concepts/010_llm_tasks.html">Language Modelling Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ai/nlp/concepts/011_appendix.html">Appendix</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../introduction.html">Generative AI</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../prompt-engineering/intro.html">Prompt Engineering</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../prompt-engineering/basic_prompting.html">Basic Prompting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../prompt-engineering/advance_prompts.html">Advanced Prompting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../prompt-engineering/prompts-applications.html">Prompts Applications</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../prompt-engineering/prompts-adversarial.html">Prompts Adversarial</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../prompt-engineering/prompts-reliability.html">Reliability</a></li>



</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../intro.html">Langchain</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../01_LangChain_Fundamentals.html">Langchain Cookbook 1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../02_LangChain_Use_Cases.html">Langchain Cookbook 2</a></li>
<li class="toctree-l3"><a class="reference internal" href="project_toc.html">Projects</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../../RAG/intro.html">RAG</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../agents/intro.html">Agents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../llm-recipes/intro.html">LLM Recipes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../evaluations/intro.html">Evaluations</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Resources</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../resources/blogs/blogs_toc.html">Blogs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../resources/courses/courses_toc.html">Courses</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../intro_me.html">About me</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/anukchat/mlguide/main?urlpath=lab/tree/content/genai/langchain/projects/2_Question_Answering.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../../../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/anukchat/mlguide/blob/main/content/genai/langchain/projects/2_Question_Answering.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../../_sources/content/genai/langchain/projects/2_Question_Answering.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Question Answering</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#top-k-similarity-search-ask-a-book-a-question">Top-K Similarity Search - Ask A Book A Question</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-your-data">Load your data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#chunk-your-data-up-into-smaller-documents">Chunk your data up into smaller documents</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-embeddings-of-your-documents-to-get-ready-for-semantic-search">Create embeddings of your documents to get ready for semantic search</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#option-1-chroma-for-local">Option #1: Chroma (for local)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#option-2-pinecone-for-cloud">Option #2: Pinecone (for cloud)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#query-those-docs-to-get-your-answer-back">Query those docs to get your answer back</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-retrieval-with-langchain">Advanced Retrieval With LangChain</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-up-our-texts-and-documents">Load up our texts and documents</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multiquery">MultiQuery</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#contextual-compression">Contextual Compression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parent-document-retriever">Parent Document Retriever</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ensemble-retriever">Ensemble Retriever</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#self-querying">Self Querying</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                   <section class="tex2jax_ignore mathjax_ignore" id="question-answering">
<h1>Question Answering<a class="headerlink" href="#question-answering" title="Link to this heading">#</a></h1>
<p>Question answering (QA) using Large Language Models (LLMs) involves leveraging these models to interpret and generate natural language responses to user queries based on vast amounts of pre-trained knowledge.</p>
<p>LLMs, like GPT-4, have been trained on diverse datasets and are capable of understanding context, nuances, and relationships in language, enabling them to provide answers on a wide range of topics.</p>
<p><strong>Closed-Domain QA:</strong> Focused on a specific topic or domain (e.g., medical, legal) with answers extracted from a defined set of documents or a knowledge base.</p>
<p><strong>Open-Domain QA:</strong> General questions where the model retrieves information from its entire training data, offering a broad, context-aware response.</p>
<section id="top-k-similarity-search-ask-a-book-a-question">
<h2>Top-K Similarity Search - Ask A Book A Question<a class="headerlink" href="#top-k-similarity-search-ask-a-book-a-question" title="Link to this heading">#</a></h2>
<p>In this tutorial we will see a simple example of basic retrieval via Top-K Similarity search</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># pip install langchain --upgrade</span>
<span class="c1"># Version: 0.0.164</span>

<span class="c1"># !pip install pypdf</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Unzip data folder</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span>
<span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="s1">&#39;../../data.zip&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_ref</span><span class="p">:</span>
    <span class="n">zip_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># PDF Loaders. If unstructured gives you a hard time, try PyPDFLoader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.document_loaders</span><span class="w"> </span><span class="kn">import</span> <span class="n">UnstructuredPDFLoader</span><span class="p">,</span> <span class="n">OnlinePDFLoader</span><span class="p">,</span> <span class="n">PyPDFLoader</span><span class="p">,</span> <span class="n">TextLoader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.text_splitter</span><span class="w"> </span><span class="kn">import</span> <span class="n">RecursiveCharacterTextSplitter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="n">load_dotenv</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<section id="load-your-data">
<h3>Load your data<a class="headerlink" href="#load-your-data" title="Link to this heading">#</a></h3>
<p>Next let’s load up some data. I’ve put a few ‘loaders’ on there which will load data from different locations. Feel free to use the one that suits you. The default one queries one of Paul Graham’s essays for a simple example. This process will only stage the loader, not actually load it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loader</span> <span class="o">=</span> <span class="n">TextLoader</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="s2">&quot;../data/PaulGrahamEssays/vb.txt&quot;</span><span class="p">)</span>

<span class="c1">## Other options for loaders </span>
<span class="c1"># loader = PyPDFLoader(&quot;../data/field-guide-to-data-science.pdf&quot;)</span>
<span class="c1"># loader = UnstructuredPDFLoader(&quot;../data/field-guide-to-data-science.pdf&quot;)</span>
<span class="c1"># loader = OnlinePDFLoader(&quot;https://wolfpaulus.com/wp-content/uploads/2017/05/field-guide-to-data-science.pdf&quot;)</span>
</pre></div>
</div>
</div>
</div>
<p>Then let’s go ahead and actually load the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Then let’s actually check out what’s been loaded</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note: If you&#39;re using PyPDFLoader then it will split by page for you already</span>
<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;You have </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s1"> document(s) in your data&#39;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">page_content</span><span class="p">)</span><span class="si">}</span><span class="s1"> characters in your sample document&#39;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Here is a sample: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">page_content</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>You have 1 document(s) in your data
There are 9155 characters in your sample document
Here is a sample: January 2016Life is short, as everyone knows. When I was a kid I used to wonder
about this. Is life actually short, or are we really complaining
about its finiteness?  Would we be just as likely to fe
</pre></div>
</div>
</div>
</div>
</section>
<section id="chunk-your-data-up-into-smaller-documents">
<h3>Chunk your data up into smaller documents<a class="headerlink" href="#chunk-your-data-up-into-smaller-documents" title="Link to this heading">#</a></h3>
<p>While we could pass the entire essay to a model w/ long context, we want to be picky about which information we share with our model. The better signal to noise ratio we have the more likely we are to get the right answer.</p>
<p>The first thing we’ll do is chunk up our document into smaller pieces. The goal will be to take only a few of those smaller pieces and pass them to the LLM.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We&#39;ll split our data into chunks around 500 characters each with a 50 character overlap. These are relatively small.</span>

<span class="n">text_splitter</span> <span class="o">=</span> <span class="n">RecursiveCharacterTextSplitter</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">chunk_overlap</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">texts</span> <span class="o">=</span> <span class="n">text_splitter</span><span class="o">.</span><span class="n">split_documents</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s see how many small chunks we have</span>
<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Now you have </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span><span class="si">}</span><span class="s1"> documents&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Now you have 20 documents
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-embeddings-of-your-documents-to-get-ready-for-semantic-search">
<h3>Create embeddings of your documents to get ready for semantic search<a class="headerlink" href="#create-embeddings-of-your-documents-to-get-ready-for-semantic-search" title="Link to this heading">#</a></h3>
<p>Next up we need to prepare for similarity searches. The way we do this is through embedding our documents (getting a vector per document).</p>
<p>This will help us compare documents later on.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.vectorstores</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chroma</span><span class="p">,</span> <span class="n">Pinecone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.embeddings.openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAIEmbeddings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pinecone</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/homebrew/lib/python3.11/site-packages/pinecone/index.py:4: TqdmExperimentalWarning: Using `tqdm.autonotebook.tqdm` in notebook mode. Use `tqdm.tqdm` instead to force console mode (e.g. in jupyter console)
  from tqdm.autonotebook import tqdm
</pre></div>
</div>
</div>
</div>
<p>Check to see if there is an environment variable with you API keys, if not, use what you put below</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">OPENAI_API_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;OPENAI_API_KEY&#39;</span><span class="p">,</span> <span class="s1">&#39;YourAPIKey&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then we’ll get our embeddings engine going. You can use whatever embeddings engine you would like. We’ll use OpenAI’s ada today.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">embeddings</span> <span class="o">=</span> <span class="n">OpenAIEmbeddings</span><span class="p">(</span><span class="n">openai_api_key</span><span class="o">=</span><span class="n">OPENAI_API_KEY</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="option-1-chroma-for-local">
<h3>Option #1: Chroma (for local)<a class="headerlink" href="#option-1-chroma-for-local" title="Link to this heading">#</a></h3>
<p>I like Chroma becauase it’s local and easy to set up without an account.</p>
<p>First we’ll pass our texts to Chroma via <code class="docutils literal notranslate"><span class="pre">.from_documents</span></code>, this will 1) embed the documents and get a vector, then 2) add them to the vectorstore for retrieval later.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load it into Chroma</span>
<span class="n">vectorstore</span> <span class="o">=</span> <span class="n">Chroma</span><span class="o">.</span><span class="n">from_documents</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s test it out. I want to see which documents are most closely related to a query.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;What is great about having kids?&quot;</span>
<span class="n">docs</span> <span class="o">=</span> <span class="n">vectorstore</span><span class="o">.</span><span class="n">similarity_search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then we can check them out. In theory, the texts which are deemed most similar should hold the answer to our question.
But keep in mind that our query just happens to be a question, it could be a random statement or sentence and it would still work.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Here&#39;s an example of the first document that was returned</span>
<span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
    <span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">doc</span><span class="o">.</span><span class="n">page_content</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>jabs into your consciousness like a pin.The things that matter aren&#39;t necessarily the ones people would
call &quot;important.&quot;  Having coffee with a friend matters.  You won&#39;t
feel later like that was a waste of time.One great thing about having small children is that they make you
spend time on things that matter: them. They grab your sleeve as
you&#39;re staring at your phone and say &quot;will you play with me?&quot; And

the question, and the answer is that life actually is short.Having kids showed me how to convert a continuous quantity, time,
into discrete quantities. You only get 52 weekends with your 2 year
old.  If Christmas-as-magic lasts from say ages 3 to 10, you only
get to watch your child experience it 8 times.  And while it&#39;s
impossible to say what is a lot or a little of a continuous quantity
like time, 8 is not a lot of something.  If you had a handful of 8

January 2016Life is short, as everyone knows. When I was a kid I used to wonder
about this. Is life actually short, or are we really complaining
about its finiteness?  Would we be just as likely to feel life was
short if we lived 10 times as long?Since there didn&#39;t seem any way to answer this question, I stopped
wondering about it.  Then I had kids.  That gave me a way to answer

done that we didn&#39;t.  My oldest son will be 7 soon.  And while I
miss the 3 year old version of him, I at least don&#39;t have any regrets
over what might have been.  We had the best time a daddy and a 3
year old ever had.Relentlessly prune bullshit, don&#39;t wait to do things that matter,
and savor the time you have.  That&#39;s what you do when life is short.Notes[1]
At first I didn&#39;t like it that the word that came to mind was
one that had other meanings.  But then I realized the other meanings
</pre></div>
</div>
</div>
</div>
</section>
<section id="option-2-pinecone-for-cloud">
<h3>Option #2: Pinecone (for cloud)<a class="headerlink" href="#option-2-pinecone-for-cloud" title="Link to this heading">#</a></h3>
<p>If you want to use pinecone, run the code below, if not then skip over to Chroma below it. You must go to <a class="reference external" href="https://www.pinecone.io/">Pinecone.io</a> and set up an account</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># PINECONE_API_KEY = os.getenv(&#39;PINECONE_API_KEY&#39;, &#39;YourAPIKey&#39;)</span>
<span class="c1"># PINECONE_API_ENV = os.getenv(&#39;PINECONE_API_ENV&#39;, &#39;us-east1-gcp&#39;) # You may need to switch with your env</span>

<span class="c1"># # initialize pinecone</span>
<span class="c1"># pinecone.init(</span>
<span class="c1">#     api_key=PINECONE_API_KEY,  # find at app.pinecone.io</span>
<span class="c1">#     environment=PINECONE_API_ENV  # next to api key in console</span>
<span class="c1"># )</span>
<span class="c1"># index_name = &quot;langchaintest&quot; # put in the name of your pinecone index here</span>

<span class="c1"># docsearch = Pinecone.from_texts([t.page_content for t in texts], embeddings, index_name=index_name)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="query-those-docs-to-get-your-answer-back">
<h3>Query those docs to get your answer back<a class="headerlink" href="#query-those-docs-to-get-your-answer-back" title="Link to this heading">#</a></h3>
<p>Great, those are just the docs which should hold our answer. Now we can pass those to a LangChain chain to query the LLM.</p>
<p>We could do this manually, but a chain is a convenient helper for us.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.chat_models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatOpenAI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.chains.question_answering</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_qa_chain</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span><span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">openai_api_key</span><span class="o">=</span><span class="n">OPENAI_API_KEY</span><span class="p">)</span>
<span class="n">chain</span> <span class="o">=</span> <span class="n">load_qa_chain</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="n">chain_type</span><span class="o">=</span><span class="s2">&quot;stuff&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;What is great about having kids?&quot;</span>
<span class="n">docs</span> <span class="o">=</span> <span class="n">vectorstore</span><span class="o">.</span><span class="n">similarity_search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">chain</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">input_documents</span><span class="o">=</span><span class="n">docs</span><span class="p">,</span> <span class="n">question</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;One great thing about having kids is that they make you spend time on things that matter. They remind you to prioritize the important things in life, like spending quality time with them. Having kids can also bring a sense of joy and fulfillment as you watch them grow and experience new things.&#39;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="advanced-retrieval-with-langchain">
<h2>Advanced Retrieval With LangChain<a class="headerlink" href="#advanced-retrieval-with-langchain" title="Link to this heading">#</a></h2>
<p>Let’s go over a few more complex and advanced retrieval methods with LangChain.</p>
<p>There is no one right way to retrieve data - it’ll depend on your application so take some time to think about it before you jump in</p>
<p>Let’s have some fun</p>
<ul class="simple">
<li><p><strong>Multi Query</strong> - Given a single user query, use an LLM to synthetically generate multiple other queries. Use each one of the new queries to retrieve documents, take the union of those documents for the final context of your prompt</p></li>
<li><p><strong>Contextual Compression</strong> - Fluff remover. Normal retrieval but with an extra step of pulling out relevant information from each returned document. This makes each relevant document smaller for your final prompt (which increases information density)</p></li>
<li><p><strong>Parent Document Retriever</strong> - Split and embed <em>small</em> chunks (for maximum information density), then return the parent documents (or larger chunks) those small chunks come from</p></li>
<li><p><strong>Ensemble Retriever</strong> - Combine multiple retrievers together</p></li>
<li><p><strong>Self-Query</strong> - When the retriever infers filters from a users query and applies those filters to the underlying data</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Unzip data folder</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span>
<span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="s1">&#39;../../data.zip&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_ref</span><span class="p">:</span>
    <span class="n">zip_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="n">load_dotenv</span><span class="p">()</span>

<span class="n">openai_api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;OPENAI_API_KEY&#39;</span><span class="p">,</span> <span class="s1">&#39;YourAPIKey&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-up-our-texts-and-documents">
<h2>Load up our texts and documents<a class="headerlink" href="#load-up-our-texts-and-documents" title="Link to this heading">#</a></h2>
<p>Then chunk them, and put them into a vector store</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.document_loaders</span><span class="w"> </span><span class="kn">import</span> <span class="n">DirectoryLoader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.embeddings.openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAIEmbeddings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.text_splitter</span><span class="w"> </span><span class="kn">import</span> <span class="n">RecursiveCharacterTextSplitter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.vectorstores</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chroma</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/gregorykamradt/opt/anaconda3/lib/python3.9/site-packages/deeplake/util/check_latest_version.py:32: UserWarning: A newer version of deeplake (3.7.2) is available. It&#39;s recommended that you update to the latest version using `pip install -U deeplake`.
  warnings.warn(
</pre></div>
</div>
</div>
</div>
<p>We’re going to load up Paul Graham’s essays. In this repo there are various sizes of folders (<code class="docutils literal notranslate"><span class="pre">PaulGrahamEssaysSmall</span></code>, <code class="docutils literal notranslate"><span class="pre">PaulGrahamEssaysMedium</span></code>, <code class="docutils literal notranslate"><span class="pre">PaulGrahamEssaysLarge</span></code> or <code class="docutils literal notranslate"><span class="pre">PaulGrahamEssays</span></code> for the full set.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loader</span> <span class="o">=</span> <span class="n">DirectoryLoader</span><span class="p">(</span><span class="s1">&#39;../data/PaulGrahamEssaysLarge/&#39;</span><span class="p">,</span> <span class="n">glob</span><span class="o">=</span><span class="s2">&quot;**/*.txt&quot;</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">docs</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|███████████████████████████████████████████| 49/49 [00:30&lt;00:00,  1.62it/s]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You have </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span><span class="si">}</span><span class="s2"> essays loaded&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>You have 49 essays loaded
</pre></div>
</div>
</div>
</div>
<p>Then we’ll split up our text into smaller sized chunks</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Split</span>
<span class="n">text_splitter</span> <span class="o">=</span> <span class="n">RecursiveCharacterTextSplitter</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">chunk_overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">splits</span> <span class="o">=</span> <span class="n">text_splitter</span><span class="o">.</span><span class="n">split_documents</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>

<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Your </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span><span class="si">}</span><span class="s2"> documents have been split into </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span><span class="si">}</span><span class="s2"> chunks&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Your 49 documents have been split into 471 chunks
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;vectordb&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span> <span class="c1"># If you&#39;ve already made your vectordb this will delete it so you start fresh</span>
    <span class="n">vectordb</span><span class="o">.</span><span class="n">delete_collection</span><span class="p">()</span>

<span class="n">embedding</span> <span class="o">=</span> <span class="n">OpenAIEmbeddings</span><span class="p">()</span>
<span class="n">vectordb</span> <span class="o">=</span> <span class="n">Chroma</span><span class="o">.</span><span class="n">from_documents</span><span class="p">(</span><span class="n">documents</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span> <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="multiquery">
<h3>MultiQuery<a class="headerlink" href="#multiquery" title="Link to this heading">#</a></h3>
<p>This retrieval method will generated 3 additional questions to get a total of 4 queries (with the users included) that will be used to go retrieve documents. This is helpful when you want to retrieve documents which are similar in meaning to your question.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.chat_models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatOpenAI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.retrievers.multi_query</span><span class="w"> </span><span class="kn">import</span> <span class="n">MultiQueryRetriever</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.prompts</span><span class="w"> </span><span class="kn">import</span> <span class="n">PromptTemplate</span>
<span class="c1"># Set logging for the queries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</pre></div>
</div>
</div>
</div>
<p>Doing some logging to see the other questions that were generated. I tried to find a way to get these via a model property but couldn’t, lmk if you find a way!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">()</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;langchain.retrievers.multi_query&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then we set up the MultiQueryRetriever which will generate other questions for us</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">question</span> <span class="o">=</span> <span class="s2">&quot;What is the authors view on the early stages of a startup?&quot;</span>
<span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span><span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">retriever_from_llm</span> <span class="o">=</span> <span class="n">MultiQueryRetriever</span><span class="o">.</span><span class="n">from_llm</span><span class="p">(</span>
    <span class="n">retriever</span><span class="o">=</span><span class="n">vectordb</span><span class="o">.</span><span class="n">as_retriever</span><span class="p">(),</span> <span class="n">llm</span><span class="o">=</span><span class="n">llm</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">unique_docs</span> <span class="o">=</span> <span class="n">retriever_from_llm</span><span class="o">.</span><span class="n">get_relevant_documents</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">question</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:langchain.retrievers.multi_query:Generated queries: [&#39;1. How does the author perceive the early stages of a startup?&#39;, &quot;2. What are the author&#39;s thoughts on the initial phases of a startup?&quot;, &quot;3. What is the author&#39;s perspective on the beginning stages of a startup?&quot;]
</pre></div>
</div>
</div>
</div>
<p>Check out how there are other questions which are related to but slightly different than the question I asked.</p>
<p>Let’s see how many docs were actually returned</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">unique_docs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8
</pre></div>
</div>
</div>
</div>
<p>Ok now let’s put those docs into a prompt template which we’ll use as context</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prompt_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Use the following pieces of context to answer the question at the end.</span>
<span class="s2">If you don&#39;t know the answer, just say that you don&#39;t know, don&#39;t try to make up an answer.</span>

<span class="si">{context}</span>

<span class="s2">Question: </span><span class="si">{question}</span>
<span class="s2">Answer:&quot;&quot;&quot;</span>
<span class="n">PROMPT</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span>
    <span class="n">template</span><span class="o">=</span><span class="n">prompt_template</span><span class="p">,</span> <span class="n">input_variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="s2">&quot;question&quot;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">llm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">PROMPT</span><span class="o">.</span><span class="n">format_prompt</span><span class="p">(</span>
    <span class="n">context</span><span class="o">=</span><span class="n">unique_docs</span><span class="p">,</span>
    <span class="n">question</span><span class="o">=</span><span class="n">question</span>
<span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;The author believes that it is important for startups to release an early version of their product quickly and then improve it based on user feedback. They emphasize the importance of getting version 1 done fast and state that startups that are too slow to release often fail.&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="contextual-compression">
<h3>Contextual Compression<a class="headerlink" href="#contextual-compression" title="Link to this heading">#</a></h3>
<p>Then we’ll move onto contextual compression. This will take the chunk that you’ve made (above) and compress it’s information down to the parts relevant to your query.</p>
<p>Say that you have a chunk that has 3 topics within it, you only really care about one of them though, this compressor will look at your query, see that you only need one of the 3 topics, then extract &amp; return that one topic.</p>
<p>This one is a bit more expensive because each doc returned will get processed an additional time (to pull out the relevant data)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.retrievers</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContextualCompressionRetriever</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.retrievers.document_compressors</span><span class="w"> </span><span class="kn">import</span> <span class="n">LLMChainExtractor</span>
</pre></div>
</div>
</div>
</div>
<p>We first need to set up our compressor, it’s cool that it’s a separate object because that means you can use it elsewhere outside this retriever as well.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span><span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s1">&#39;gpt-4&#39;</span><span class="p">)</span>

<span class="n">compressor</span> <span class="o">=</span> <span class="n">LLMChainExtractor</span><span class="o">.</span><span class="n">from_llm</span><span class="p">(</span><span class="n">llm</span><span class="p">)</span>
<span class="n">compression_retriever</span> <span class="o">=</span> <span class="n">ContextualCompressionRetriever</span><span class="p">(</span><span class="n">base_compressor</span><span class="o">=</span><span class="n">compressor</span><span class="p">,</span>
                                                       <span class="n">base_retriever</span><span class="o">=</span><span class="n">vectordb</span><span class="o">.</span><span class="n">as_retriever</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<p>First, an example of compression. Below we have one of our splits that we made above</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">page_content</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&quot;July 2006I&#39;ve discovered a handy test for figuring out what you&#39;re addicted\n\nto.  Imagine you were going to spend the weekend at a friend&#39;s house\n\non a little island off the coast of Maine.  There are no shops on\n\nthe island and you won&#39;t be able to leave while you&#39;re there.  Also,\n\nyou&#39;ve never been to this house before, so you can&#39;t assume it will\n\nhave more than any house might.What, besides clothes and toiletries, do you make a point of packing?\n\nThat&#39;s what you&#39;re addicted to.  For example, if you find yourself\n\npacking a bottle of vodka (just in case), you may want to stop and\n\nthink about that.For me the list is four things: books, earplugs, a notebook, and a\n\npen.There are other things I might bring if I thought of it, like music,\n\nor tea, but I can live without them.  I&#39;m not so addicted to caffeine\n\nthat I wouldn&#39;t risk the house not having any tea, just for a\n\nweekend.Quiet is another matter.  I realize it seems a bit eccentric to\n\ntake earplugs on a trip to an island off the coast of Maine.  If\n\nanywhere should be quiet, that should.  But what if the person in\n\nthe next room snored?  What if there was a kid playing basketball?\n\n(Thump, thump, thump... thump.)  Why risk it?  Earplugs are small.Sometimes I can think with noise.  If I already have momentum on\n\nsome project, I can work in noisy places.  I can edit an essay or\n\ndebug code in an airport.  But airports are not so bad: most of the\n\nnoise is whitish.  I couldn&#39;t work with the sound of a sitcom coming&quot;
</pre></div>
</div>
</div>
</div>
<p>Now we are going to pass a question to it and with that question we will compress the doc. The cool part is this doc will be contextually compressed, meaning the resulting file will only have the information relevant to the question.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">compressor</span><span class="o">.</span><span class="n">compress_documents</span><span class="p">(</span><span class="n">documents</span><span class="o">=</span><span class="p">[</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">query</span><span class="o">=</span><span class="s2">&quot;test for what you like to do&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Great so we had a long document, now we have a shorter document with more dense information. Great for getting rid of the fluff. Let’s try it out on our essays</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">question</span> <span class="o">=</span> <span class="s2">&quot;What is the authors view on the early stages of a startup?&quot;</span>
<span class="n">compressed_docs</span> <span class="o">=</span> <span class="n">compression_retriever</span><span class="o">.</span><span class="n">get_relevant_documents</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">compressed_docs</span><span class="p">))</span>
<span class="n">compressed_docs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Document(page_content=&#39;The thing I probably repeat most is this recipe for a startup: get\n\na version 1 out fast, then improve it based on users\&#39; reactions.By &quot;release early&quot; I don\&#39;t mean you should release something full\n\nof bugs, but that you should release something minimal.  Users hate\n\nbugs, but they don\&#39;t seem to mind a minimal version 1, if there\&#39;s\n\nmore coming soon.There are several reasons it pays to get version 1 done fast.  One\n\nis that this is simply the right way to write software, whether for\n\na startup or not.  I\&#39;ve been repeating that since 1993, and I haven\&#39;t seen much since to\n\ncontradict it.  I\&#39;ve seen a lot of startups die because they were\n\ntoo slow to release stuff, and none because they were too quick.&#39;, metadata={&#39;source&#39;: &#39;../data/PaulGrahamEssaysLarge/startuplessons.txt&#39;}),
 Document(page_content=&#39;&quot;Bring us your startups early,&quot; said Google\&#39;s speaker at the Startup School.  They\&#39;re quite\n\nexplicit about it: they like to acquire startups at just the point\n\nwhere they would do a Series A round.  (The Series A round is the\n\nfirst round of real VC funding; it usually happens in the first\n\nyear.) It is a brilliant strategy, and one that other big technology\n\ncompanies will no doubt try to duplicate.&#39;, metadata={&#39;source&#39;: &#39;../data/PaulGrahamEssaysLarge/vcsqueeze.txt&#39;}),
 Document(page_content=&quot;Building office buildings for technology companies won&#39;t get you a\n\nsilicon valley, because the key stage in the life of a startup\n\nhappens before they want that kind of space.  The key stage is when\n\nthey&#39;re three guys operating out of an apartment.  Wherever the\n\nstartup is when it gets funded, it will stay.  The defining quality&quot;, metadata={&#39;source&#39;: &#39;../data/PaulGrahamEssaysLarge/siliconvalley.txt&#39;}),
 Document(page_content=&#39;of a startup, which in its raw form is more a distraction than a motivator.&#39;, metadata={&#39;source&#39;: &#39;../data/PaulGrahamEssaysLarge/vcsqueeze.txt&#39;})]
</pre></div>
</div>
</div>
</div>
<p>We now have 4 docs but they are shorter and only contain the information that is relevant to our query.</p>
<p>Let’s put it in our prompt template again.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prompt_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Use the following pieces of context to answer the question at the end.</span>
<span class="s2">If you don&#39;t know the answer, just say that you don&#39;t know, don&#39;t try to make up an answer.</span>

<span class="si">{context}</span>

<span class="s2">Question: </span><span class="si">{question}</span>
<span class="s2">Answer:&quot;&quot;&quot;</span>
<span class="n">PROMPT</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span>
    <span class="n">template</span><span class="o">=</span><span class="n">prompt_template</span><span class="p">,</span> <span class="n">input_variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="s2">&quot;question&quot;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">llm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">PROMPT</span><span class="o">.</span><span class="n">format_prompt</span><span class="p">(</span>
    <span class="n">context</span><span class="o">=</span><span class="n">compressed_docs</span><span class="p">,</span>
    <span class="n">question</span><span class="o">=</span><span class="n">question</span>
<span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&quot;The author believes that the early stages of a startup are crucial. He advises startups to release a minimal version 1 of their product quickly and then improve it based on user feedback. He also mentions that many startups fail because they are too slow to release their products. Furthermore, he notes that the key stage in a startup&#39;s life often happens when it&#39;s still a small operation, possibly operating out of an apartment.&quot;
</pre></div>
</div>
</div>
</div>
</section>
<section id="parent-document-retriever">
<h3>Parent Document Retriever<a class="headerlink" href="#parent-document-retriever" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="https://python.langchain.com/docs/modules/data_connection/retrievers/parent_document_retriever">LangChain documentation</a> does a great job describing this - my minor edits below:</p>
<p>When you split your docs, you generally may want to have small documents, so that their embeddings can most accurately reflect their meaning. If too long, then the embeddings can lose meaning.</p>
<p>But at the same time you may want to have information around those small chunks to keep context of the longer document.</p>
<p>The ParentDocumentRetriever strikes that balance by splitting and storing small chunks of data. During retrieval, it first fetches the small chunks but then looks up the parent ids for those chunks and returns those larger documents.</p>
<p>Note that “parent document” refers to the document that a small chunk originated from. This can either be the whole raw document OR a larger chunk.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.retrievers</span><span class="w"> </span><span class="kn">import</span> <span class="n">ParentDocumentRetriever</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemoryStore</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This text splitter is used to create the child documents. They should be small chunk size.</span>
<span class="n">child_splitter</span> <span class="o">=</span> <span class="n">RecursiveCharacterTextSplitter</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The vectorstore to use to index the child chunks</span>
<span class="n">vectorstore</span> <span class="o">=</span> <span class="n">Chroma</span><span class="p">(</span>
    <span class="n">collection_name</span><span class="o">=</span><span class="s2">&quot;return_full_documents&quot;</span><span class="p">,</span>
    <span class="n">embedding_function</span><span class="o">=</span><span class="n">OpenAIEmbeddings</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The storage layer for the parent documents</span>
<span class="n">store</span> <span class="o">=</span> <span class="n">InMemoryStore</span><span class="p">()</span>

<span class="n">retriever</span> <span class="o">=</span> <span class="n">ParentDocumentRetriever</span><span class="p">(</span>
    <span class="n">vectorstore</span><span class="o">=</span><span class="n">vectorstore</span><span class="p">,</span> 
    <span class="n">docstore</span><span class="o">=</span><span class="n">store</span><span class="p">,</span> 
    <span class="n">child_splitter</span><span class="o">=</span><span class="n">child_splitter</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we will add the whole essays that we split above. We haven’t chunked these essays yet, but the <code class="docutils literal notranslate"><span class="pre">.add_documents</span></code> will do the small chunking for us with the <code class="docutils literal notranslate"><span class="pre">child_splitter</span></code> above</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retriever</span><span class="o">.</span><span class="n">add_documents</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now if we were to put in a question or query, we’ll get small chunks returned</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sub_docs</span> <span class="o">=</span> <span class="n">vectorstore</span><span class="o">.</span><span class="n">similarity_search</span><span class="p">(</span><span class="s2">&quot;what is some investing advice?&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sub_docs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Document(page_content=&quot;people there are rich, or expect to be when their options vest.\n\nOrdinary employees find it very hard to recommend an acquisition;\n\nit&#39;s just too annoying to see a bunch of twenty year olds get rich\n\nwhen you&#39;re still working for salary.  Even if it&#39;s the right thing\n\nfor your company to do.The Solution(s)Bad as things look now, there is a way for VCs to save themselves.&quot;, metadata={&#39;doc_id&#39;: &#39;a4372dda-31dc-477f-9239-2ac45d11f3db&#39;, &#39;source&#39;: &#39;../data/PaulGrahamEssaysLarge/vcsqueeze.txt&#39;}),
 Document(page_content=&quot;the product is expensive to develop or sell, or simply because\n\nthey&#39;re wasteful.If you&#39;re paying attention, you&#39;ll be asking at this point not just\n\nhow to avoid the fatal pinch, but how to avoid being default dead.\n\nThat one is easy: don&#39;t hire too fast.  Hiring too fast is by far\n\nthe biggest killer of startups that raise money.&quot;, metadata={&#39;doc_id&#39;: &#39;0314fd17-e53a-4c6e-9d80-2a721b8800df&#39;, &#39;source&#39;: &#39;../data/PaulGrahamEssaysLarge/aord.txt&#39;}),
 Document(page_content=&quot;[1]\n\nBut investors are so fickle that you can never\n\ndo more than start to count on them.  Sometimes something about your\n\nbusiness will spook investors even if your growth is great.  So no\n\nmatter how good your growth is, you can never safely treat fundraising\n\nas more than a plan A. You should always have a plan B as well: you\n\nshould know (as in write down) precisely what you&#39;ll need to do to&quot;, metadata={&#39;doc_id&#39;: &#39;0314fd17-e53a-4c6e-9d80-2a721b8800df&#39;, &#39;source&#39;: &#39;../data/PaulGrahamEssaysLarge/aord.txt&#39;}),
 Document(page_content=&quot;commitment.If an acquirer thinks you&#39;re going to stick around no matter what,\n\nthey&#39;ll be more likely to buy you, because if they don&#39;t and you\n\nstick around, you&#39;ll probably grow, your price will go up, and\n\nthey&#39;ll be left wishing they&#39;d bought you earlier.  Ditto for\n\ninvestors.  What really motivates investors, even big VCs, is not\n\nthe hope of good returns, but the fear of missing out.\n\n[6]&quot;, metadata={&#39;doc_id&#39;: &#39;ad7c0de6-ec3d-4637-9dea-8de2d37fa505&#39;, &#39;source&#39;: &#39;../data/PaulGrahamEssaysLarge/startuplessons.txt&#39;})]
</pre></div>
</div>
</div>
</div>
<p>Look how small those chunks are. Now we want to get the parent doc which those small docs are a part of.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retrieved_docs</span> <span class="o">=</span> <span class="n">retriever</span><span class="o">.</span><span class="n">get_relevant_documents</span><span class="p">(</span><span class="s2">&quot;what is some investing advice?&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>I’m going to only do the first doc to save space, but there are more waiting for you. Keep in mind that LangChain will do the union of docs, so if you have two child docs from the same parent doc, you’ll only return the parent doc once, not twice.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retrieved_docs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">page_content</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&quot;November 2005In the next few years, venture capital funds will find themselves\n\nsqueezed from four directions.  They&#39;re already stuck with a seller&#39;s\n\nmarket, because of the huge amounts they raised at the end of the\n\nBubble and still haven&#39;t invested.  This by itself is not the end\n\nof the world.  In fact, it&#39;s just a more extreme version of the\n\nnorm\n\nin the VC business: too much money chasing too few deals.Unfortunately, those few deals now want less and less money, because\n\nit&#39;s getting so cheap to start a startup.  The four causes: open\n\nsource, which makes software free; Moore&#39;s law, which makes hardware\n\ngeometrically closer to free; the Web, which makes promotion free\n\nif you&#39;re good; and better languages, which make development a lot\n\ncheaper.When we started our startup in 1995, the first three were our biggest\n\nexpenses.  We had to pay $5000 for the Netscape Commerce Server,\n\nthe only software that then supported secure http connections.  We\n\npaid $3000 for a server with a 90&quot;
</pre></div>
</div>
</div>
</div>
<p>However here we got the full document back. Sometimes this will be too long and we actually just want to get a larger chunk instead. Let’s do that.</p>
<p>Notice the chunk size difference between the parent splitter and child splitter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This text splitter is used to create the parent documents</span>
<span class="n">parent_splitter</span> <span class="o">=</span> <span class="n">RecursiveCharacterTextSplitter</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>

<span class="c1"># This text splitter is used to create the child documents</span>
<span class="c1"># It should create documents smaller than the parent</span>
<span class="n">child_splitter</span> <span class="o">=</span> <span class="n">RecursiveCharacterTextSplitter</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

<span class="c1"># The vectorstore to use to index the child chunks</span>
<span class="n">vectorstore</span> <span class="o">=</span> <span class="n">Chroma</span><span class="p">(</span><span class="n">collection_name</span><span class="o">=</span><span class="s2">&quot;return_split_parent_documents&quot;</span><span class="p">,</span> <span class="n">embedding_function</span><span class="o">=</span><span class="n">OpenAIEmbeddings</span><span class="p">())</span>

<span class="c1"># The storage layer for the parent documents</span>
<span class="n">store</span> <span class="o">=</span> <span class="n">InMemoryStore</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>This will set up our retriever for us</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retriever</span> <span class="o">=</span> <span class="n">ParentDocumentRetriever</span><span class="p">(</span>
    <span class="n">vectorstore</span><span class="o">=</span><span class="n">vectorstore</span><span class="p">,</span> 
    <span class="n">docstore</span><span class="o">=</span><span class="n">store</span><span class="p">,</span> 
    <span class="n">child_splitter</span><span class="o">=</span><span class="n">child_splitter</span><span class="p">,</span>
    <span class="n">parent_splitter</span><span class="o">=</span><span class="n">parent_splitter</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now this time when we add documents two things will happen</p>
<ol class="arabic simple">
<li><p>Larger chunks - We’ll split our docs into large chunks</p></li>
<li><p>Smaller chunks - We’ll split our docs into smaller chunks</p></li>
</ol>
<p>Both of them will be combined.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retriever</span><span class="o">.</span><span class="n">add_documents</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s check out how many documents we have now</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">store</span><span class="o">.</span><span class="n">yield_keys</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>385
</pre></div>
</div>
</div>
</div>
<p>Then let’s go get our small chunks to make sure it’s working and see how long they are</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sub_docs</span> <span class="o">=</span> <span class="n">vectorstore</span><span class="o">.</span><span class="n">similarity_search</span><span class="p">(</span><span class="s2">&quot;what is some investing advice?&quot;</span><span class="p">)</span>
<span class="n">sub_docs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Document(page_content=&quot;people there are rich, or expect to be when their options vest.\n\nOrdinary employees find it very hard to recommend an acquisition;\n\nit&#39;s just too annoying to see a bunch of twenty year olds get rich\n\nwhen you&#39;re still working for salary.  Even if it&#39;s the right thing\n\nfor your company to do.The Solution(s)Bad as things look now, there is a way for VCs to save themselves.&quot;, metadata={&#39;doc_id&#39;: &#39;d7cfabc8-b712-4fd1-8f1c-917c66cfdb68&#39;, &#39;source&#39;: &#39;../data/PaulGrahamEssaysLarge/vcsqueeze.txt&#39;}),
 Document(page_content=&quot;commitment.If an acquirer thinks you&#39;re going to stick around no matter what,\n\nthey&#39;ll be more likely to buy you, because if they don&#39;t and you\n\nstick around, you&#39;ll probably grow, your price will go up, and\n\nthey&#39;ll be left wishing they&#39;d bought you earlier.  Ditto for\n\ninvestors.  What really motivates investors, even big VCs, is not\n\nthe hope of good returns, but the fear of missing out.\n\n[6]&quot;, metadata={&#39;doc_id&#39;: &#39;f6df5dfa-47e4-46be-9e77-8303a512b8c1&#39;, &#39;source&#39;: &#39;../data/PaulGrahamEssaysLarge/startuplessons.txt&#39;}),
 Document(page_content=&quot;April 2006(This essay is derived from a talk at the 2006\n\nStartup School.)The startups we&#39;ve funded so far are pretty quick, but they seem\n\nquicker to learn some lessons than others.  I think it&#39;s because\n\nsome things about startups are kind of counterintuitive.We&#39;ve now\n\ninvested\n\nin enough companies that I&#39;ve learned a trick\n\nfor determining which points are the counterintuitive ones:&quot;, metadata={&#39;doc_id&#39;: &#39;d9e056c8-fee1-43e7-bbb1-8c3c435d663c&#39;, &#39;source&#39;: &#39;../data/PaulGrahamEssaysLarge/startuplessons.txt&#39;}),
 Document(page_content=&quot;the title of this essay, you already know most of what you need to\n\nknow about M&amp;A in the first year.Notes[1]\n\nI&#39;m not saying you should never sell.  I&#39;m saying you should\n\nbe clear in your own mind about whether you want to sell or not,\n\nand not be led by manipulation or wishful thinking into trying to\n\nsell earlier than you otherwise would have.[2]&quot;, metadata={&#39;doc_id&#39;: &#39;88d1d80d-dbb7-4c10-bfee-48df7f551452&#39;, &#39;source&#39;: &#39;../data/PaulGrahamEssaysLarge/corpdev.txt&#39;})]
</pre></div>
</div>
</div>
</div>
<p>Now, let’s do the full process, we’ll see what small chunks are generated, but then return the larger chunks as our relevant documents</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">larger_chunk_relevant_docs</span> <span class="o">=</span> <span class="n">retriever</span><span class="o">.</span><span class="n">get_relevant_documents</span><span class="p">(</span><span class="s2">&quot;what is some investing advice?&quot;</span><span class="p">)</span>
<span class="n">larger_chunk_relevant_docs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Document(page_content=&#39;means VCs are now in the business of finding promising little 2-3\n\nman startups and pumping them up into companies that cost $100\n\nmillion to acquire.   They didn\&#39;t mean to be in this business; it\&#39;s\n\njust what their business has evolved into.Hence the fourth problem: the acquirers have begun to realize they\n\ncan buy wholesale.  Why should they wait for VCs to make the startups\n\nthey want more expensive?  Most of what the VCs add, acquirers don\&#39;t\n\nwant anyway.  The acquirers already have brand recognition and HR\n\ndepartments.  What they really want is the software and the developers,\n\nand that\&#39;s what the startup is in the early phase: concentrated\n\nsoftware and developers.Google, typically, seems to have been the first to figure this out.\n\n&quot;Bring us your startups early,&quot; said Google\&#39;s speaker at the Startup School.  They\&#39;re quite\n\nexplicit about it: they like to acquire startups at just the point\n\nwhere they would do a Series A round.  (The Series A round is the\n\nfirst round of real VC funding; it usually happens in the first\n\nyear.) It is a brilliant strategy, and one that other big technology\n\ncompanies will no doubt try to duplicate.  Unless they want to have\n\nstill more of their lunch eaten by Google.Of course, Google has an advantage in buying startups: a lot of the\n\npeople there are rich, or expect to be when their options vest.\n\nOrdinary employees find it very hard to recommend an acquisition;\n\nit\&#39;s just too annoying to see a bunch of twenty year olds get rich\n\nwhen you\&#39;re still working for salary.  Even if it\&#39;s the right thing\n\nfor your company to do.The Solution(s)Bad as things look now, there is a way for VCs to save themselves.\n\nThey need to do two things, one of which won\&#39;t surprise them, and\n\nanother that will seem an anathema.Let\&#39;s start with the obvious one: lobby to get Sarbanes-Oxley\n\nloosened.  This law was created to prevent future Enrons, not to\n\ndestroy the IPO market.  Since the IPO market was practically dead&#39;, metadata={&#39;source&#39;: &#39;../data/PaulGrahamEssaysLarge/vcsqueeze.txt&#39;})
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prompt_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Use the following pieces of context to answer the question at the end.</span>
<span class="s2">If you don&#39;t know the answer, just say that you don&#39;t know, don&#39;t try to make up an answer.</span>

<span class="si">{context}</span>

<span class="s2">Question: </span><span class="si">{question}</span>
<span class="s2">Answer:&quot;&quot;&quot;</span>
<span class="n">PROMPT</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span>
    <span class="n">template</span><span class="o">=</span><span class="n">prompt_template</span><span class="p">,</span> <span class="n">input_variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="s2">&quot;question&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">question</span> <span class="o">=</span> <span class="s2">&quot;what is some investing advice?&quot;</span>

<span class="n">llm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">PROMPT</span><span class="o">.</span><span class="n">format_prompt</span><span class="p">(</span>
    <span class="n">context</span><span class="o">=</span><span class="n">larger_chunk_relevant_docs</span><span class="p">,</span>
    <span class="n">question</span><span class="o">=</span><span class="n">question</span>
<span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&quot;One piece of investing advice is to release a minimal version 1 of a product quickly, then improve it based on users&#39; reactions. This is because it&#39;s dangerous to guess what users will like without knowing them. Another advice is for Venture Capitalists to lobby to get Sarbanes-Oxley loosened, as this law was not created to destroy the IPO market. Additionally, it&#39;s advised not to sell a startup too early, but to be clear about whether you want to sell or not, and not be led by manipulation or wishful thinking.&quot;
</pre></div>
</div>
</div>
</div>
</section>
<section id="ensemble-retriever">
<h3>Ensemble Retriever<a class="headerlink" href="#ensemble-retriever" title="Link to this heading">#</a></h3>
<p>The next one on our list combines multiple retrievers together. The goal here is to see what multiple methods return, then pull them together for (hopefully) better results.</p>
<p>You may need to install bm25 with <code class="docutils literal notranslate"><span class="pre">!pip</span> <span class="pre">install</span> <span class="pre">rank_bm25</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.retrievers</span><span class="w"> </span><span class="kn">import</span> <span class="n">BM25Retriever</span><span class="p">,</span> <span class="n">EnsembleRetriever</span>
</pre></div>
</div>
</div>
</div>
<p>We’ll use a <a class="reference external" href="https://en.wikipedia.org/wiki/Okapi_BM25">BM25 retriever</a> for this one which is really good at keyword matching (vs semantic). When you combine this method with regular semantic search it’s known as hybrid search.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># initialize the bm25 retriever and faiss retriever</span>
<span class="n">bm25_retriever</span> <span class="o">=</span> <span class="n">BM25Retriever</span><span class="o">.</span><span class="n">from_documents</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span>
<span class="n">bm25_retriever</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">embedding</span> <span class="o">=</span> <span class="n">OpenAIEmbeddings</span><span class="p">()</span>
<span class="n">vectordb</span> <span class="o">=</span> <span class="n">Chroma</span><span class="o">.</span><span class="n">from_documents</span><span class="p">(</span><span class="n">splits</span><span class="p">,</span> <span class="n">embedding</span><span class="p">)</span>
<span class="n">vectordb</span> <span class="o">=</span> <span class="n">vectordb</span><span class="o">.</span><span class="n">as_retriever</span><span class="p">(</span><span class="n">search_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># initialize the ensemble retriever</span>
<span class="n">ensemble_retriever</span> <span class="o">=</span> <span class="n">EnsembleRetriever</span><span class="p">(</span><span class="n">retrievers</span><span class="o">=</span><span class="p">[</span><span class="n">bm25_retriever</span><span class="p">,</span> <span class="n">vectordb</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ensemble_docs</span> <span class="o">=</span> <span class="n">ensemble_retriever</span><span class="o">.</span><span class="n">get_relevant_documents</span><span class="p">(</span><span class="s2">&quot;what is some investing advice?&quot;</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">ensemble_docs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prompt_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Use the following pieces of context to answer the question at the end.</span>
<span class="s2">If you don&#39;t know the answer, just say that you don&#39;t know, don&#39;t try to make up an answer.</span>

<span class="si">{context}</span>

<span class="s2">Question: </span><span class="si">{question}</span>
<span class="s2">Answer:&quot;&quot;&quot;</span>
<span class="n">PROMPT</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span>
    <span class="n">template</span><span class="o">=</span><span class="n">prompt_template</span><span class="p">,</span> <span class="n">input_variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="s2">&quot;question&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">question</span> <span class="o">=</span> <span class="s2">&quot;what is some investing advice?&quot;</span>

<span class="n">llm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">PROMPT</span><span class="o">.</span><span class="n">format_prompt</span><span class="p">(</span>
    <span class="n">context</span><span class="o">=</span><span class="n">ensemble_docs</span><span class="p">,</span>
    <span class="n">question</span><span class="o">=</span><span class="n">question</span>
<span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&quot;One piece of investing advice is to make a larger number of smaller investments instead of a handful of giant ones. It is also suggested to fund younger, more technical founders instead of MBAs and let the founders remain as CEO. Another advice is that the best sources of seed funding are successful startup founders, as they can also provide valuable advice. However, it&#39;s important to be aware of the changing nature of the world and industries, as what may seem like a bad idea initially could become a good one due to changes in the world.&quot;
</pre></div>
</div>
</div>
</div>
</section>
<section id="self-querying">
<h3>Self Querying<a class="headerlink" href="#self-querying" title="Link to this heading">#</a></h3>
<p>The last one we’ll look at today is self querying. This is when the retriever has the ability to query itself. It does this so it can use filters when doing it’s final query.</p>
<p>This means it’ll use the users query for semantic search, but also its own query for filtering (so the user doesn’t have to give a structured filter).</p>
<p>You may need to install <code class="docutils literal notranslate"><span class="pre">!pip</span> <span class="pre">install</span> <span class="pre">lark</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.retrievers.self_query.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">SelfQueryRetriever</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.chains.query_constructor.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">AttributeInfo</span>

<span class="n">embeddings</span> <span class="o">=</span> <span class="n">OpenAIEmbeddings</span><span class="p">()</span>
<span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span><span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s1">&#39;gpt-4&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;vectorstore&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span> <span class="c1"># If you&#39;ve already made your vectordb this will delete it so you start fresh</span>
    <span class="n">vectorstore</span><span class="o">.</span><span class="n">delete_collection</span><span class="p">()</span>

<span class="n">vectorstore</span> <span class="o">=</span> <span class="n">Chroma</span><span class="o">.</span><span class="n">from_documents</span><span class="p">(</span>
    <span class="n">splits</span><span class="p">,</span> <span class="n">embeddings</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Below is the information on the fitlers available. This will help the model know which filters to semantically search for</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">metadata_field_info</span><span class="o">=</span><span class="p">[</span>
    <span class="n">AttributeInfo</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;source&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The filename of the essay&quot;</span><span class="p">,</span> 
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string or list[string]&quot;</span><span class="p">,</span> 
    <span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">document_content_description</span> <span class="o">=</span> <span class="s2">&quot;Essays from Paul Graham&quot;</span>
<span class="n">retriever</span> <span class="o">=</span> <span class="n">SelfQueryRetriever</span><span class="o">.</span><span class="n">from_llm</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span>
                                        <span class="n">vectorstore</span><span class="p">,</span>
                                        <span class="n">document_content_description</span><span class="p">,</span>
                                        <span class="n">metadata_field_info</span><span class="p">,</span>
                                        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">enable_limit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retriever</span><span class="o">.</span><span class="n">get_relevant_documents</span><span class="p">(</span><span class="s2">&quot;Return only 1 essay. What is one thing you can do to figure out what you like to do from source &#39;../data/PaulGrahamEssaysLarge/island.txt&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>query=&#39;figure out what you like to do&#39; filter=Comparison(comparator=&lt;Comparator.EQ: &#39;eq&#39;&gt;, attribute=&#39;source&#39;, value=&#39;../data/PaulGrahamEssaysLarge/island.txt&#39;) limit=1
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Document(page_content=&quot;if I could only figure out what.As for books, I know the house would probably have something to\n\nread.  On the average trip I bring four books and only read one of\n\nthem, because I find new books to read en route.  Really bringing\n\nbooks is insurance.I realize this dependence on books is not entirely good—that what\n\nI need them for is distraction.  The books I bring on trips are\n\noften quite virtuous, the sort of stuff that might be assigned\n\nreading in a college class.  But I know my motives aren&#39;t virtuous.\n\nI bring books because if the world gets boring I need to be able\n\nto slip into another distilled by some writer.  It&#39;s like eating\n\njam when you know you should be eating fruit.There is a point where I&#39;ll do without books.  I was walking in\n\nsome steep mountains once, and decided I&#39;d rather just think, if I\n\nwas bored, rather than carry a single unnecessary ounce.  It wasn&#39;t\n\nso bad.  I found I could entertain myself by having ideas instead\n\nof reading other people&#39;s.  If you stop eating jam, fruit starts\n\nto taste better.So maybe I&#39;ll try not bringing books on some future trip.  They&#39;re\n\ngoing to have to pry the plugs out of my cold, dead ears, however.&quot;, metadata={&#39;source&#39;: &#39;../data/PaulGrahamEssaysLarge/island.txt&#39;})]
</pre></div>
</div>
</div>
</div>
<p>It’s kind of annoying to have to put in the full file name, a user doesn’t want to do that. Let’s change <code class="docutils literal notranslate"><span class="pre">source</span></code> to <code class="docutils literal notranslate"><span class="pre">essay</span></code> and the file path w/ the essay name</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">:</span>
    <span class="n">split</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;essay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^/]+(?=\.\w+$)&#39;</span><span class="p">,</span> <span class="n">split</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Ok now that we did that, let’s make a new field info config</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">metadata_field_info</span><span class="o">=</span><span class="p">[</span>
    <span class="n">AttributeInfo</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;essay&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The name of the essay&quot;</span><span class="p">,</span> 
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string or list[string]&quot;</span><span class="p">,</span> 
    <span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;vectorstore&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span> <span class="c1"># If you&#39;ve already made your vectordb this will delete it so you start fresh</span>
    <span class="n">vectorstore</span><span class="o">.</span><span class="n">delete_collection</span><span class="p">()</span>

<span class="n">vectorstore</span> <span class="o">=</span> <span class="n">Chroma</span><span class="o">.</span><span class="n">from_documents</span><span class="p">(</span>
    <span class="n">splits</span><span class="p">,</span> <span class="n">embeddings</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">document_content_description</span> <span class="o">=</span> <span class="s2">&quot;Essays from Paul Graham&quot;</span>
<span class="n">retriever</span> <span class="o">=</span> <span class="n">SelfQueryRetriever</span><span class="o">.</span><span class="n">from_llm</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span>
                                        <span class="n">vectorstore</span><span class="p">,</span>
                                        <span class="n">document_content_description</span><span class="p">,</span>
                                        <span class="n">metadata_field_info</span><span class="p">,</span>
                                        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">enable_limit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retriever</span><span class="o">.</span><span class="n">get_relevant_documents</span><span class="p">(</span><span class="s2">&quot;Tell me about investment advice the &#39;worked&#39; essay? return only 1&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>query=&#39;investment advice&#39; filter=Comparison(comparator=&lt;Comparator.EQ: &#39;eq&#39;&gt;, attribute=&#39;essay&#39;, value=&#39;worked&#39;) limit=1
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Document(page_content=&#39;should make a larger number of smaller investments instead of a\n\nhandful of giant ones, they should be funding younger, more technical\n\nfounders instead of MBAs, they should let the founders remain as\n\nCEO, and so on.One of my tricks for writing essays had always been to give talks.\n\nThe prospect of having to stand up in front of a group of people\n\nand tell them something that won\&#39;t waste their time is a great\n\nspur to the imagination. When the Harvard Computer Society, the\n\nundergrad computer club, asked me to give a talk, I decided I would\n\ntell them how to start a startup. Maybe they\&#39;d be able to avoid the\n\nworst of the mistakes we\&#39;d made.So I gave this talk, in the course of which I told them that the\n\nbest sources of seed funding were successful startup founders,\n\nbecause then they\&#39;d be sources of advice too. Whereupon it seemed\n\nthey were all looking expectantly at me. Horrified at the prospect\n\nof having my inbox flooded by business plans (if I\&#39;d only known),\n\nI blurted out &quot;But not me!&quot; and went on with the talk. But afterward\n\nit occurred to me that I should really stop procrastinating about\n\nangel investing. I\&#39;d been meaning to since Yahoo bought us, and now\n\nit was 7 years later and I still hadn\&#39;t done one angel investment.Meanwhile I had been scheming with Robert and Trevor about projects\n\nwe could work on together. I missed working with them, and it seemed&#39;, metadata={&#39;essay&#39;: &#39;worked&#39;, &#39;source&#39;: &#39;../data/PaulGrahamEssaysLarge/worked.txt&#39;})]
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "anukchat/mlguide",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./content/genai/langchain/projects"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>
<div class="section ablog__blog_comments">
   
</div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Anukool Chaturvedi
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <div class="social-icons">
    <a href="https://twitter.com/chaturanukool" target="_blank"><i class="fab fa-twitter"></i></a>
    <a href="https://linkedin.com/in/anukool-chaturvedi" target="_blank"><i class="fab fa-linkedin"></i></a>
    <a href="https://github.com/anukchat" target="_blank"><i class="fab fa-github"></i></a>
    </p>
</div>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>